function htmlEncode(t){return $("<div/>").text(t).html()}function htmlDecode(t){return $("<div/>").html(t).text()}function stripHash(t){return t.replace("#","")}function stripAtDetail(t){return stringArr=t.split(" at "),stringArr[0]=stringArr[0].replace("Last ",""),stringArr[0]}function slideLeft(t){var a=$(t).parent().parent();a.find(".cardBack-1").addClass("slideOutLeft"),a.find(".cardBack-2").addClass("slideInLeft")}function slideRight(t){var a=$(t).parent().parent().parent();a.find(".cardBack-1").removeClass("slideOutLeft"),a.find(".cardBack-2").removeClass("slideInLeft")}function getHighlightDates(t){return t.startRange===t.endRange?t.startRange:void 0}$(".prevButton").on("mousedown",function(){$(this).removeClass("button-shadow")}),$(".prevButton").on("mouseup",function(){$(this).addClass("button-shadow")}),$(".nextButton").on("mousedown",function(){$(this).removeClass("button-shadow")}),$(".nextButton").on("mouseup",function(){$(this).addClass("button-shadow")}),$(document).keydown(function(t){var a=t.keyCode||t.which,e={left:37,up:38,right:39,down:40};switch(a){case e.left:$(".prevButton").trigger("click");break;case e.right:$(".nextButton").trigger("click");break;default:return}t.preventDefault()}),moment.locale("en",{calendar:{lastDay:"[Yesterday at] LT",sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",lastWeek:"dddd [at] LT",nextWeek:"[next] dddd [at] LT",sameElse:"ll"}});var deferred=$.Deferred(),offline=!1;if(offline){var data=[{id:"5584077dedd7cc047e86fe34",type:"top10",thumbnailMedia:"chart.html",startRange:"2015-06-25",endRange:"2015-06-25",objectTags:["music"],actionTags:["listen"],position:0,properties:{sum:{"album-name":{"The Inevitable End":{__count__:10}}}},generatedDate:"2015-06-19T12:13:49.256Z",chart:"/v1/users/ed/rollups/day/music/listen/sum.album-name..__count__/.json"},{id:"5584077dedd7cc047e86fe30",type:"top10",thumbnailMedia:"chart.html",startRange:"2015-06-25",endRange:"2015-06-25",objectTags:["music"],actionTags:["listen"],position:2,properties:{sum:{"artist-name":{"Daft Punk":{__count__:1}}}},generatedDate:"2015-06-19T12:13:49.017Z",chart:"/v1/users/ed/rollups/day/music/listen/sum.album-name..__count__/.json"},{id:"5584077dedd7cc047e86fe35",type:"bottom10",thumbnailMedia:"chart.html",startRange:"2015-06-25",endRange:"2015-06-25",objectTags:["computer","control","software","source"],actionTags:["github","push"],position:28,properties:{sum:{commits:5}},generatedDate:"2015-06-19T12:13:49.301Z",chart:"/v1/users/ed/rollups/day/computer,control,software,source/github,push/sum.commits/.json"},{id:"5584077dedd7cc047e86fe39",type:"top10",thumbnailMedia:"chart.html",startRange:"2015-06-25",endRange:"2015-06-25",objectTags:["computer","control","software","source"],actionTags:["commit"],position:1,properties:{sum:{__count__:5}},generatedDate:"2015-06-19T12:13:49.626Z",chart:"/v1/users/ed/rollups/day/computer,control,software,source/github,push/sum.__count__/.json"},{id:"5584077dedd7cc047e86fe3a",type:"bottom10",thumbnailMedia:"chart.html",startRange:"2015-06-25",endRange:"2015-06-25",objectTags:["computer","control","software","source"],actionTags:["github","push"],position:0,properties:{sum:{repo:{"1self/api":{__count__:1}}}},generatedDate:"2015-06-19T12:13:49.630Z",chart:"/v1/users/ed/rollups/day/computer,control,software,source/github,push/sum.repo.1self/api.__count__/.json"},{id:"5584077dedd7cc047e86fe32",type:"top10",thumbnailMedia:"chart.html",startRange:"2015-06-25",endRange:"2015-06-25",objectTags:["computer","control","software","source"],actionTags:["github","push"],position:0,properties:{sum:{repo:{"1self/api":{commits:1}}}},generatedDate:"2015-06-19T12:13:49.036Z",chart:"/v1/users/ed/rollups/day/computer,control,software,source/github,push/sum.repo.1self/api.commits/.json"},{id:"5584077dedd7cc047e86fe37",type:"bottom10",thumbnailMedia:"chart.html",startRange:"2015-06-25",endRange:"2015-06-25",objectTags:["computer","git","github","software","source control"],actionTags:["commit"],position:8,properties:{sum:{__count__:5}},generatedDate:"2015-06-19T12:13:49.528Z",chart:"/v1/users/ed/rollups/day/computer,git,github,software,source control/commit/sum.__count__/.json"},{id:"5584077dedd7cc047e86fe3c",type:"bottom10",thumbnailMedia:"chart.html",startRange:"2015-06-25",endRange:"2015-06-25",objectTags:["computer","git","github","software","source control"],actionTags:["commit"],position:6,properties:{sum:{"author-email":{"ed^sykes@gmail^com":{__count__:5}}}},generatedDate:"2015-06-19T12:13:49.862Z",chart:"/v1/users/ed/rollups/day/computer,git,github,software,source control/commit/sum.author-email.ed^sykes@gmail^com.__count__/.json"}];deferred.resolve(data)}else{var username=getQSParam().user,minStdDev=getQSParam().minStdDev,maxStdDev=getQSParam().maxStdDev,sort_by_date=function(t,a){return new Date(a.cardDate).getTime()-new Date(t.cardDate).getTime()};console.log("minStdDev",minStdDev),username||(username="ed");var url="https://api-staging.1self.co/v1/users/";url+=username+"/cards",url+=minStdDev?"?minStdDev="+minStdDev:"?minStdDev=2",url+=maxStdDev?"&maxStdDev="+maxStdDev:"",console.log(url),$.getJSON(url,function(){console.log("accessed api for cards")}).done(function(t){t.sort(sort_by_date),console.log("card data",t),window.cardData=t,deferred.resolve(t)}).fail(function(t){console.log("error getting cards",t)})}$(function(){function t(t){var a=$(t),e=a.attr("id"),o=a.parent();a.detach(),o.append(t)}function a(t,a){var e=t.length-1,o=t.length,r=null;if(a!==e){r=t[a];for(var n=a;o>n;++n)t[n]=t[n+1];t[e]=r}}function e(t,a){$(".stack li").removeClass(a),void 0!==t&&$(t).addClass(a)}var o,r=function(t){var a=["#dd2649","#00a2d4","#e93d31","#f2ae1c","#61b346","#cf4b9a","#367ec0","#00ad87"];return a[t%a.length]},n=function(t,a,e){var o={};o.eventCategory="card-stack",o.eventAction=t,o.eventLabel=a,o.eventValue=e,console.log("gaObj",o),ga("send","event",o)},s=function(t,a){var e,o=moment();return t===a?(t=moment(t),e=t.calendar()):(t=moment(t),a=moment(a),e=t.format("lll")+" - "+a.format("lll")),e},i=function(t){var a="";for(var e in t)a+=t[e]+" ";return a.trim()};String.prototype.supplant=function(t){return this.replace(/\{\{([^{}]*)\}\}/g,function(a,e){var o=t[e];return"string"==typeof o||"number"==typeof o?o:a})};var d=function(t,a){var e="";return e="top10"===a?"most":"fewest",t>0&&(e=ordinal_suffix_of(t+1,!0)+" "+e),e},c=function(t){var a=[];for(var e in t){var o;o="push"===t[e]?"es":"s",a.push(t[e]+o)}return a},l=function(t){var a=[];for(var e in t){var o;o="commit"===t[e]?"ted":"s",a.push(t[e]+o)}return a},u=function(t){return t.replace(/\^/g,".").replace(/-/g," ")},p=function(t){return"artist-name"===t?"":"album-name"===t?"tracks from the album":t.indexOf("percent")>=0?t.replace("percent","").trim():t.indexOf("duration")>=0?t.replace("duration","").trim():t},h=function(t){return"computer desktop"===t?"computer use":t},m=function(t){for(var a=t.toPrecision(3)+"";a.indexOf(".")>=0&&("0"===a.charAt(a.length-1)||"."===a.charAt(a.length-1));)a=a.substring(0,a.length-1);return a},g=function(t){for(var a="",e=Object.keys(t)[0],o,r=0,n={},s=!1,i=!1;e&&"__count__"!==e;){var d=u(p(e));t=t[e],o=e,e.indexOf("duration")>=0?s=!0:e.indexOf("percent")>=0&&(i=!0),e="object"==typeof t?Object.keys(t)[0]:null,""!==d&&(a+=d,e&&"__count__"!==e&&(a+=": ")),r++}return n.propertiesText=a,"__count__"===e?n.value=t[e]:n.value=t,s?n.value<60?n.value=m(n.value)+" seconds":n.value=moment.duration(n.value,"seconds").humanize():i&&(n.value=m(n.value)+"%"),n},v=function(t,a){if(!t.cardText){var e="";if("top10"===t.type||"bottom10"===t.type){var o="<b>{{eventDate}}</b><br>{{comparitor}} {{action_pl}} in {{eventPeriod}} {{comparisonPeriod}}",r="<b>{{eventDate}}</b><br>{{comparitor}} {{action_pp}} {{property}} in {{eventPeriod}} {{comparisonPeriod}}",n="<b>{{eventDate}}</b><br>{{comparitor}} {{objects}} {{action_pl}} in {{eventPeriod}} {{comparisonPeriod}}",u="<b>{{eventDate}}</b><br>{{comparitor}} {{action_pl}} to {{property}} in {{eventPeriod}} {{comparisonPeriod}}",p="<b>{{eventDate}}</b><br>{{comparitor}} {{objects}} {{property}} in {{eventPeriod}} {{comparisonPeriod}}",m="<b>{{eventDate}}</b><br>{{value}} {{action_pl}} to {{property}}<br>Your {{comparitor}} in {{eventPeriod}} {{comparisonPeriod}}",v="<b>{{eventDate}}</b><br>{{value}} {{property}} {{objects}}<br>Your {{comparitor}} in {{eventPeriod}} {{comparisonPeriod}}",f={eventDate:stripAtDetail(s(t.startRange,t.endRange)),comparitor:d(t.position,t.type),eventPeriod:"a day",comparisonPeriod:"",colour:a},b=g(t.properties.sum);"commit"===t.actionTags[0]||"push"===t.actionTags[1]?t.properties.sum.__count__?(f.action_pl=i(c(t.actionTags)),e=o.supplant(f)):(f.action_pp=i(l(t.actionTags)),f.property=b.propertiesText,e=r.supplant(f)):"listen"===t.actionTags[0]?t.properties.sum.__count__?(f.action_pl=i(c(t.actionTags)),f.objects=i(t.objectTags),e=n.supplant(f)):(f.action_pl=i(c(t.actionTags)),f.property=b.propertiesText,f.value=b.value,e=m.supplant(f)):"use"===t.actionTags[0]&&(f.property=b.propertiesText,f.objects=h(i(t.objectTags)),f.value=b.value,e=v.supplant(f)),e=e.supplant(f)}""===e&&(e="Couldn't create friendly message"),t.cardText=e}},f=[,'  <div class="avatar-button standard-shadow">','    <!--div class="icon-button"><i class="fa fa-share-alt fa-2x"></i></div-->',"  </div>",'  <div class="share-button standard-shadow" style="background-color: {{colour}};">','    <div class="icon-button"><i class="fa fa-share-alt fa-2x"></i></div>',"  </div>",'  <div class="flip-toggle standard-shadow" style="background-color: {{colour}};">','    <div class="icon-button"><i class="fa fa-angle-double-{{action}} fa-2x"></i></div>','    <!--div class="icon-button icon-{{action}}"><img src="img/{{action}}-icon.png" /></div-->',"  </div>"].join(""),b=[,'<div class="cardBack-1">','  <div class="cardHeader" style="background-color: {{colour}};"><p>{{headerText}}</p></div>','    <div class="cardBackMain">','      <div class="cardBackTitle" style="border-bottom-color:{{colour}}"><p>{{chartTitleText}}</p></div>','      <div class="cardBackMedia">','        <!--iframe class="mainChartFrame" src="{{mainChartSrc}}" scrolling="no"></iframe-->',"      </div>","    </div>",'    <!--div class="cardBackAction" onclick="slideLeft(this)"><div class="actionText">Explore &gt;</div></div-->',"</div>",'<!--div class="cardBack-2">','  <div class="cardHeader" style="background-color: {{colour}};"><p class="backButton" onclick="slideRight(this)">{{headerText2}}</p></div>','  <div class="cardBackMain">Next bit of info goes here</div>',"</div-->","{{shareContainer}}"].join(""),T=[,'<div class="share-container {{shareContainerClasses}} hide" style="background-color: {{colour}};">','  <div class="social-share-button standard-shadow"><div id="shareToTwitter" class="innerButton">Share to Twitter</div></div>','  <div class="social-share-button standard-shadow"><div id="shareToFacebook" class="innerButton">Share to Facebook</div></div>','  <div class="social-share-button standard-shadow"><div id="shareToLink" class="innerButton">Get shareable link</div></div>',"</div>"].join(""),_=function(t,a){var e=moment(t.cardDate);t.colourIndex=a;var o=r(a),n={headerText:"",cardNavText:"",colour:o,colourIndex:a},s='<input id="hidCard_{{id}}" class="cardData" type="hidden" value="{{inputValue}}" />';if(s+='<div class="cardContainer cardContainer-front standard-shadow">{{cardFrontContent}}</div>',s+='<div class="cardContainer cardContainer-back standard-shadow">',s+="  {{cardBackContent}}",s+="{{cardNav}}</div>",s=s.supplant({id:t.id,inputValue:encodeURIComponent(JSON.stringify(t)),cardNav:f.supplant({colour:o,action:"left"})}),"date"===t.type){var i=stripAtDetail(e.calendar());s=s.supplant({cardFrontContent:'<div class="cardFullText" style="background-color: {{colour}};"><p>{{dateNow}}</p></div>'.supplant({dateNow:i,colour:o})})}else if("top10"===t.type||"bottom10"===t.type){var c;c="use"===t.actionTags[0]?"img/rescuetimeicon.svg":"listen"===t.actionTags[0]?"img/lastfm.svg":"img/githubicon.svg",v(t,o);var l="top10"===t.type?"Top":"Bottom";l+=" 10: "+d(t.position,t.type)+" of "+t.outOf;var u=[,'<div class="cardHeader" style="background-color: {{colour}};">',"  <p>{{headerText}}</p>","</div>",'<div class="cardContentContainer">','  <div class="cardMedia" style="border-bottom-color: {{colour}};"></div>','  <div class="cardText">','    <div class="glance-row">','      <div class="glance-blob-cell"><div class="glance-blob glance-blob-left" style="background-color:{{colour}};border-color:{{colour}}"><p>{{position}}</p></div></div><div class="glance-blob-cell"><div class="glance-blob glance-blob-right" style="background-image:url({{dataSourceIconUrl}});border-color:{{colour}}"></div></div>',"    </div>",'    <div class="main-text-row"><p>{{data}}</p></div>',"  </div>","</div>","{{shareContainer}}",'<div class="cardNav" style="background-color: {{colour}};">',"  <p>{{cardNavText}}</p>","  {{flipButton}}","</div>"].join("");s=s.supplant({cardFrontContent:u.supplant({data:t.cardText||"undefined",flipButton:f.supplant({colour:o,action:"right"}),cardNavText:"",colour:o,headerText:l,shareContainer:T.supplant({colour:o,shareContainerClasses:"share-container-front"}),dataSourceIconUrl:c,position:ordinal_suffix_of(t.position+1,!0)}),cardBackContent:b.supplant({colour:o,headerText:l,headerText2:"&lt; back",chartTitleText:t.cardText,shareContainer:T.supplant({colour:o,shareContainerClasses:"share-container-back"})})})}return s},w=function(t){if(t){var a=$(t).find(".cardData");if(a=decodeURIComponent(a.val()),a=JSON.parse(a),a.thumbnailMedia){var e=$(t).find(".cardMedia");e.empty();var o='<iframe class="thumbnailFrame" src="'+a.thumbnailMedia;o+="?lineColour="+stripHash(r(a.colourIndex)),o+="&highlightCondition="+a.type,o+="&highlightDates="+getHighlightDates(a),o+="&doTransitions=true",o+="&dataSrc="+encodeURIComponent(a.chart)+'" ',o+='scrolling="no"></iframe>',o+='<div class="clickable-overlay"></div>',e.append(o)}}},k=function(t){console.log("rendering main media");var a=$(t).find(".cardData");if(a=decodeURIComponent(a.val()),a=JSON.parse(a),a.thumbnailMedia){var e=$(t).find(".cardBackMedia");e.empty();var o='<iframe class="mainChartFrame" src="'+a.thumbnailMedia;o+="?lineColour="+stripHash(r(a.colourIndex)),o+="&highlightCondition="+a.type,o+="&highlightDates="+getHighlightDates(a),o+="&vaxis=true&haxis=true",o+="&displayTooltips=true",o+="&doTransitions=false",o+="&dataSrc="+a.chart+'" ',o+='scrolling="no"></iframe>',e.append(o)}},x=[],C=null,y=0,D,I=function(t,a,e,o){var n=document.createElement("li");n.innerHTML=_(a,e);var s=$(n).find(".cardContainer");s.css({"border-color":r(e)}),$(n).attr("id","card_"+y),$(n).attr("cardId",a.id),$(n).attr("cardIndex",e),$(n).addClass("mainPile"),$(".stack").append(n),t.createCard(n),o&&w(n),y++},j=function(t){var o=10,r=0;deferred.done(function(s){D=s,o>s.length&&(o=s.length);for(var i=o+r-1;i>=r;i--)I(t,s[i],i,i===r);e($(".stack li:last")[0],"topOfMain"),C=$(".stack li");var d=$(".stack");d.on("mouseup","li",function(t){var o="#"+this.id,r=x.indexOf(o);r>-1&&(a(x,r),e($(o),"topOfDiscard"))}),d.on("mousedown",".flip-toggle",function(t){$(".flip-toggle").removeClass("standard-shadow")}),d.on("mouseup",".flip-toggle",function(t){$(".flip-toggle").addClass("standard-shadow")}),d.on("mouseup",".clickable-overlay, .flip-toggle",function(t){var a=$(this).parents(".cardContainer"),e=$(this).parents("li");a.hasClass("flip")?n("flipped-to-front-"+e.attr("cardIndex"),e.attr("cardId"),e.attr("cardIndex")):(k(e),n("flipped-to-back-"+e.attr("cardIndex"),e.attr("cardId"),e.attr("cardIndex"))),a.toggleClass("flip"),a.siblings().toggleClass("flip")}),d.on("mousedown",".share-button",function(t){$(".share-button").removeClass("standard-shadow")}),d.on("mouseup",".share-button",function(t){$(".share-button").addClass("standard-shadow");var a=$(this).parents(".cardContainer"),e=$(this).parents("li"),o=a.find(".share-container").hasClass("hide")?"open":"close";o+="-share-pane-",o+=a.hasClass("flip")?"back":"front",o+="-"+e.attr("cardIndex"),n(o,e.attr("cardId"),e.attr("cardIndex")),a.find(".share-container").toggleClass("hide")}),d.on("mousedown","#shareToTwitter",function(t){$("#shareToTwitter").parents(".social-share-button").removeClass("standard-shadow")}),d.on("mouseup","#shareToTwitter",function(t){$("#shareToTwitter").parents(".social-share-button").addClass("standard-shadow");var a=$(this).parents(".cardContainer"),e=$(this).parents("li"),o="share-to-twitter-";o+=a.hasClass("flip")?"back":"front",o+="-"+e.attr("cardIndex"),n(o,e.attr("cardId"),e.attr("cardIndex"))}),d.on("mousedown","#shareToFacebook",function(t){console.log($("#shareToFacebook").parent().attr("class")),$("#shareToFacebook").parent("div").toggleClass("standard-shadow"),console.log($("#shareToFacebook").parent().attr("class"))}),d.on("mouseup","#shareToFacebook",function(t){$("#shareToFacebook").parent("div").addClass("standard-shadow");var a=$(this).parents(".cardContainer"),e=$(this).parents("li"),o="share-to-facebook-";o+=a.hasClass("flip")?"back":"front",o+="-"+e.attr("cardIndex"),n(o,e.attr("cardId"),e.attr("cardIndex"))}),d.on("mousedown","#shareToLink",function(t){$("#shareToLink").parents(".social-share-button").removeClass("standard-shadow")}),d.on("mouseup","#shareToLink",function(t){$("#shareToLink").parents(".social-share-button").addClass("standard-shadow");var a=$(this).parents(".cardContainer"),e=$(this).parents("li"),o="share-to-link-";o+=a.hasClass("flip")?"back":"front",o+="-"+e.attr("cardIndex"),n(o,e.attr("cardId"),e.attr("cardIndex"))}),$(".bottom-of-stack-container h1").text("All done"),$(".bottom-of-stack-container h1").after('<i class="fa fa-thumbs-o-up fa-4x"></i>'),$(".bottom-of-stack-container p").text("Come back for more cards later")})},O={throwOutConfidence:function(t,a){return Math.min(Math.abs(t+180)/a.offsetWidth,1)}};o=gajus.Swing.Stack(O),o.throwInLast=function(){var a=$(".stack .topOfDiscard")[0];if(a){t(a);var e="#"+a.id,r=x.indexOf(e),s=o.getCard(a);s.throwIn(a.thrownX,a.thrownY),n("button-thrown-in-"+a.getAttribute("cardIndex"),a.getAttribute("cardId"),a.getAttribute("cardIndex"))}},o.throwOutNext=function(){var a=$(".stack .topOfMain")[0];if(a){t(a);var e=o.getCard(a);a.thrownY=getRandomInt(-100,100),a.thrownX=1,e.throwOut(a.thrownX,a.thrownY),n("button-thrown-out-"+a.getAttribute("cardIndex"),a.getAttribute("cardId"),a.getAttribute("cardIndex"))}},window.stack=o,j(o),o.on("throwout",function(t){e($(".stack .topOfMain")[0],"topOfMain"),e(t.target,"topOfDiscard"),$(t.target).toggleClass("discardPile mainPile"),x.push("#"+t.target.id),t.target.thrownX=1,t.target.thrownY=78;var a=x.length;e(C[C.length-1-a],"topOfMain"),w(C[C.length-1-a]),t.target.classList.remove("in-deck"),console.log("thrown out",t.target.id,x),n("thrown-out-"+t.target.getAttribute("cardIndex"),t.target.getAttribute("cardId"),t.target.getAttribute("cardIndex")),$(".discardPile").add(".topOfDiscard").delay(500).fadeOut(300,function(){$(this).remove(),console.log("removed card")})}),o.on("throwin",function(t){x.pop();var a=$(x[x.length-1])[0];e(t.target,"topOfMain"),e(a,"topOfDiscard"),$(t.target).toggleClass("discardPile mainPile"),t.target.classList.add("in-deck"),console.log("thrown in",t.target.id,x),n("thrown-out-"+t.target.getAttribute("cardIndex"),t.target.getAttribute("cardId"),t.target.getAttribute("cardIndex"))})});